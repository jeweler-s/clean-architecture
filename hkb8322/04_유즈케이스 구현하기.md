# ë„ë©”ì¸ ëª¨ë¸ êµ¬í˜„

```java
package buckpal.domain;

public class Account {
    private AccountId id;
    private Money baselineBalance;
    private ActivityWindow activityWindow;

    public Money calculateBalance() {
        return Money.add(
                this.baselineBalance,
                this.activityWindow.calculateBalance(this.id)
        );
    }

    public boolean withdraw(Money money, AccountId targetAccountId) {
        if(!mayWithdraw(money)) {
            return false;
        }

        Activity withdrawal = new Activity(
                this.id,
                this.id,
                targetAccountId,
                LocalDateTime.now(),
                money
        );

        this.activityWindow.addActivity(withdrawal);
        return true;
    }

    private boolean mayWithdraw(Money money) {
        return Money.add(
                this.calculateBalance(),
                money.negate()
        ).isPositive();
    }

    public boolean deposit(Money money, AccountId sourceAccountId) {
        Activity deposit = new Activity(
                this.id,
                sourceAccountId,
                this.id,
                LocalDateTime.now(),
                money
        );

        this.activityWindow.addActivity(deposit);

        return true;
    }

    @Value
    public static class AccountId {
        private Long value;
    }
}
```

# ìœ ìŠ¤ì¼€ì´ìŠ¤ ë‘˜ëŸ¬ë³´ê¸°

```java
package buckpal.application.service;

@RequiredArgsConstructor
@Transactional(readOnly = true)
public class SendMoneyService **implements SendMoneyUseCase** { // ì¸ì»¤ë° í¬íŠ¸ ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„

    // ì•„ì›ƒê³ ì‰ í¬íŠ¸ ì¸í„°í˜ì´ìŠ¤ í˜¸ì¶œ
    **private final LoadAccountPort loadAccountPort;
    private final AccountLock accountLock;
    private final UpdateAccountStatePort updateAccountStatePort;**

    @Transactional
    @Override
    public boolean sendMoney(SendMoneyCommand command) {
        //TODO: ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ê²€ì¦
        //TODO: ëª¨ë¸ ìƒíƒœ ì¡°ì‘
        //TODO: ì¶œë ¥ ê°’ ë°˜í™˜
        return false;
    }
}
```

## ì¼ë°˜ì ì¸ ë‹¨ê³„

1. ì…ë ¥ì„ ë°›ìŒ
2. ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ê²€ì¦
3. ëª¨ë¸ ìƒíƒœ ì¡°ì‘
4. ì¶œë ¥ ë°˜í™˜

# ì…ë ¥ ìœ íš¨ì„± ê²€ì¦

## ì…ë ¥ ìœ íš¨ì„± ê²€ì¦ì˜ ì±…ì„

- ìœ ìŠ¤ì¼€ì´ìŠ¤ì˜ ì±…ì„ì€ ì•„ë‹ˆì§€ë§Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µì˜ ì±…ì„ì— í•´ë‹¹

## ì…ë ¥ ëª¨ë¸

- ìœ ìŠ¤ì¼€ì´ìŠ¤ì— ì…ë ¥ì„ ì „ë‹¬í•˜ê¸° ì „ ì…ë ¥ ìœ íš¨ì„± ê²€ì¦ì„ ì§„í–‰í•˜ê¸° ìœ„í•œ ëª¨ë¸
- ìœ ìŠ¤ì¼€ì´ìŠ¤ëŠ” í•˜ë‚˜ ì´ìƒì˜ ì–´ëŒ‘í„°ì—ì„œ í˜¸ì¶œë˜ë¯€ë¡œ ì–´ëŒ‘í„°ì—ì„œ ì…ë ¥ ìœ íš¨ì„± ê²€ì¦ì„ ë§¤ë²ˆ êµ¬í˜„í•˜ëŠ” ê²ƒì€ ì ì ˆí•˜ì§€ ì•ŠìŒ
- ìœ ìŠ¤ì¼€ì´ìŠ¤ì˜ APIì˜ ì¼ë¶€ë¯€ë¡œ ì¸ì»¤ë° í¬íŠ¸ íŒ¨í‚¤ì§€ì— ìœ„ì¹˜ (ìœ ìŠ¤ì¼€ì´ìŠ¤ ì˜¤ì—¼ ë°©ì§€)

**â‡’ ì‚¬ì‹¤ìƒ ìœ ì¦ˆì¼€ì´ìŠ¤ì˜ ì˜¤ë¥˜ ë°©ì§€ ê³„ì¸µ(Anti Corruption Layer)ì— í•´ë‹¹**

## ì˜ˆì œ

```java
package buckpal.application.port.in;

@Value
@Getter
@EqualsAndHashCode(callSuper = false)
public class SendMoneyCommand extends SelfValidating<SendMoneyCommand> {

    @NotNull
    private final AccountId sourceAccountId;

    @NotNull
    private final AccountId targetAccountId;

    @NotNull
    private final Money money;

    public SendMoneyCommand(
            AccountId sourceAccountId,
            AccountId targetAccountId,
            Money money) {
        // ìƒì„±ìì—ì„œ ê²€ì¦
        this.sourceAccountId = sourceAccountId;
        this.targetAccountId = targetAccountId;
        this.money = money;
        this.validateSelf();
    }
}
```

- Bean Validation APIë¡œë„ ê°€ëŠ¥

# ìƒì„±ìì˜ í˜

## ë¹Œë” ì‚¬ìš© ì‹œ ì£¼ì˜ì 

```java
new SendMoneyCommandBuilder()
      .sourceAccountId(new AccountId(41L))
      .targetAccountId(new AccountId(42L))
      // ... initialize many other fields
      .build();
```

- í•„ë“œ ë³€ê²½ ì‹œ ë¹Œë”ë¥¼ í˜¸ì¶œí•˜ëŠ” ì½”ë“œì— ë°˜ì˜ì´ ëˆ„ë½ë  ìˆ˜ ìˆìŒ
    - ìƒì„±ìë¥¼ ì‚¬ìš©í•œë‹¤ë©´ ì»´íŒŒì¼ëŸ¬ ì˜¤ë¥˜ë¥¼ í†µí•´ í™•ì¸ ê°€ëŠ¥

# ìœ ìŠ¤ì¼€ì´ìŠ¤ë§ˆë‹¤ ë‹¤ë¥¸ ì…ë ¥ ëª¨ë¸

## ìœ ìŠ¤ì¼€ì´ìŠ¤ë³„ ì…ë ¥ ëª¨ë¸ ë¶„ë¦¬

- ê° ìœ ìŠ¤ì¼€ì´ìŠ¤ ì „ìš© ì…ë ¥ ëª¨ë¸ì€ ìœ ìŠ¤ì¼€ì´ìŠ¤ë¥¼ í›¨ì”¬ ëª…í™•í•˜ê²Œ í•¨
- ë‹¤ë¥¸ ìœ ìŠ¤ì¼€ì´ìŠ¤ì™€ ê²°í•©ë„ ì œê±°í•˜ì—¬ ë¶ˆí•„ìš”í•œ ë¶€ìˆ˜íš¨ê³¼ê°€ ë°œìƒí•˜ì§€ ì•Šê²Œ í•¨

# ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ê²€ì¦í•˜ê¸°

## ì…ë ¥ ìœ íš¨ì„± ê²€ì¦ ğŸ†š ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™

### ì…ë ¥ ìœ íš¨ì„± ê²€ì¦

- êµ¬ë¬¸ìƒì˜(syntactical) ìœ íš¨ì„± ê²€ì¦
- **ë„ë©”ì¸ì˜ í˜„ì¬ ìƒíƒœì— ì ‘ê·¼í•˜ì§€ ì•Šê³ ë„ í™•ì¸ ê°€ëŠ¥**
- EX) ì†¡ê¸ˆë˜ëŠ” ê¸ˆì•¡ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•œë‹¤

### ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™

- ìœ ìŠ¤ì¼€ì´ìŠ¤ ë§¥ë½ ì†ì—ì„œ ì˜ë¯¸ì ì¸(semantical) ìœ íš¨ì„± ê²€ì¦
- EX) ì¶œê¸ˆ ê³„ì¢ŒëŠ” ì´ˆê³¼ ì¶œê¸ˆë˜ì–´ì„œëŠ” ì•ˆ ëœë‹¤

## ê²€ì¦ ë°©ì•ˆ

### 1) ë„ë©”ì¸ì— ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ í¬í•¨

```java
package buckpal.domain;

public class Account {
  // ...
  public boolean withdraw(Money money, AccountId targetAccountId) {
        if (!mayWithdraw(money)) {
            return false;
        }
        // ...
}
```

### 2) ìœ ì¦ˆì¼€ì´ìŠ¤ ì½”ë“œì—ì„œ ë„ë©”ì¸ ì—”í‹°í‹° ì‚¬ìš© ì „ ì§„í–‰

```java
@RequiredArgsConstructor
@Transactional
public class SendMoneyService implements SendMoneyUseCase {
      // ...
      @Override
      public boolean sendMoney(SendMoneyCommand command) {
          requireAccountExists(command.getSourceAccountId());
          requireAccountExists(command.getTargetAccountId());
       }
}
```

# í’ë¶€í•œ ë„ë©”ì¸ ëª¨ë¸ ğŸ†š ë¹ˆì•½í•œ ë„ë©”ì¸ ëª¨ë¸

## í’ë¶€í•œ ë„ë©”ì¸ ëª¨ë¸

- ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ì–´ì— ìˆëŠ” ì—”í‹°í‹°ì—ì„œ ê°€ëŠ¥í•œ í•œ ë§ì€ ë„ë©”ì¸ ë¡œì§ êµ¬í˜„
- ì—”í‹°í‹°ë“¤ì€ ìƒíƒœ ë³€ê²½ ë©”ì„œë“œ ì œê³µ, ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ì— ë§ëŠ” ìœ íš¨í•œ ë³€ê²½ë§Œì„ í—ˆìš©

## ë¹ˆì•½í•œ ë„ë©”ì¸ ëª¨ë¸

- ë„ë©”ì¸ ì—”í‹°í‹°ê°€ ìƒíƒœë¥¼ í‘œí˜„í•˜ëŠ” í•„ë“œì™€ ê°’ì„ ì½ê³  ë°”ê¾¸ê¸° ìœ„í•œ Getter, Setterë§Œì„ í¬í•¨
- ë„ë©”ì¸ ë¡œì§ì„ ê°€ì§€ê³  ìˆì§€ ì•ŠìŒ
- ë„ë©”ì¸ ë¡œì§ì´ ìœ ìŠ¤ì¼€ì´ìŠ¤ í´ë˜ìŠ¤ì— êµ¬í˜„ë˜ê³  ìˆìŒ
- `í’ë¶€í•¨`ì´ ì—”í‹°í‹° ëŒ€ì‹  ìœ ìŠ¤ì¼€ì´ìŠ¤ì— ì¡´ì¬

â‡’ í•„ìš”ì— ë§ê²Œ ì„ íƒí•˜ì—¬ ì‚¬ìš©

# ìœ ìŠ¤ì¼€ì´ìŠ¤ë§ˆë‹¤ ë‹¤ë¥¸ ì¶œë ¥ ëª¨ë¸

## ì¶œë ¥ ëª¨ë¸ ì„¤ê³„ ì‹œ ìœ ì˜ì‚¬í•­

- ì¶œë ¥ì€ í˜¸ì¶œìì—ê²Œ í•„ìš”í•œ ë°ì´í„°ë§Œ ì§„í–‰
- ìœ ìŠ¤ì¼€ì´ìŠ¤ë“¤ ê°„ ë™ì¼í•œ ì¶œë ¥ ëª¨ë¸ ê³µìœ  ì‹œ ìœ ìŠ¤ì¼€ì´ìŠ¤ë“¤ë„ ê°•í•˜ê²Œ ê²°í•©
- SRP ì ìš©í•˜ì—¬ ëª¨ë¸ ë¶„ë¦¬

# ì½ê¸° ì „ìš© ìœ ìŠ¤ì¼€ì´ìŠ¤ëŠ” ì–´ë–¨ê¹Œ?

```java
@RequiredArgsConstructor
// UseCase (X), QueryService (O)
class GetAccountBalanceService implements GetAccountBalanceQuery { // ì¸ì»¤ë° í¬íŠ¸ êµ¬í˜„

    private final LoadAccountPort loadAccountPort; // ì•„ì›ƒê³ ì‰ í¬íŠ¸ í˜¸ì¶œ

    @Override
    public Money getAccountBalance(AccountId accountId) {
        return loadAccountPort.loadAccount(accountId, LocalDateTime.now())
                .calculateBalance();
    }
}
```

- ìœ ìŠ¤ì¼€ì´ìŠ¤ë¡œ ê°„ì£¼ë˜ì§€ ì•Šì„ ê²½ìš° ì‹¤ì œ ìœ ìŠ¤ì¼€ì´ìŠ¤ì™€ êµ¬ë¶„í•˜ê¸° ìœ„í•´ ì¿¼ë¦¬ ì„œë¹„ìŠ¤ë¡œ êµ¬í˜„ ê°€ëŠ¥
- ë°ì´í„° ë¡œë“œë¥¼ ìœ„í•´ ì•„ì›ƒ ê³ ì‰ í¬íŠ¸ í˜¸ì¶œ
- `CQS`, `CQRS` ê°œë…ê³  ì˜ ë“¤ì–´ë§ìŒ

# ê²°ë¡ 

- ì´ ì±…ì˜ ì•„í‚¤í…ì²˜ëŠ” ë„ë©”ì¸ ë¡œì§ì„ ììœ ë¡­ê²Œ êµ¬í˜„í•˜ë„ë¡ ìœ ë„
- í•˜ì§€ë§Œ ì…ì¶œë ¥ ëª¨ë¸ì„ ë…ë¦½ì ìœ¼ë¡œ ëª¨ë¸ë§ì„ í•´ì•¼ ì‚¬ì´ë“œ ì´í™íŠ¸ íšŒí”¼ ê°€ëŠ¥
